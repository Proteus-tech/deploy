#!/bin/bash
if [ $# -lt 3 ]; then
    echo "Usage: start-buildbot-server client project_name repository privacy bits region size ami"
    echo ""
    echo "client: is profab client"
    echo "project_name: name of the project that buildbot run against"
    echo "repository: URL to the repository"
    echo "privacy: privacy of repository (public|private)"
    echo "bits: could be either 32 or 64*"
    echo "region: could be us-west-1*, us-west-2 or ap-southeast-1"
    echo "size: size of the instance (default is t1.micro)"
    echo "ami: is AMI ID (default is ami-4d580408 which is Ubuntu Natty)"
    exit 1
else
    client=$1
    project_name=$2
    repository=$3
    privacy=${4-public}
    bits=${5-64}
    region=${6-us-west-1}
    size=${7-t1.micro}
    ami=${8-ami-4d580408}
    
    roles=proteus.www_home 

    if [ $privacy = "private" ]; then
        echo "do hand shaking for private repository"
        roles="${roles} --proteus.credentials $repository"
    fi
    
    roles="${roles} --proteus.buildbot_master $repository --proteus.buildbot_slave $repository --proteus.start_buildbot_master $project_name --proteus.start_buildbot_slave $project_name smarthost --proteus.tag mta,exim4 --proteus.tag buildbot,combo-$project_name --proteus.tag Name,buildbot-$project_name"

    pf-server-start $client --security_group ssh --security_group http wsgi --bits $bits --region $region --size $size --ami $ami $roles
fi

