#!/bin/bash
if [ $# -lt 5 ]; then
    echo "Usage: setup-pg-slave-on-server client ec2_host ec2_master_host project_name repository privacy"
    echo ""
    echo "client: is profab client"
    echo "ec2_host: public host of EC2 instance"
    echo "ec2_master_host : buildbot-master public host of EC2 instance or use 'localhost' -"
    echo "    if setup buildbot-slave in same server as buildbot-master"
    echo "project_name: name of the project that buildbot run against"
    echo "repository: URL to the repository"
    echo "privacy: privacy of repository (public|private)"
    exit 1
else
    client=$1
    ec2_host=$2
    ec2_master_host=$3
    project_name=$4
    repository=$5
    privacy=${6-public}

    roles=proteus.www_home

    if [ $privacy = "private" ]; then
        echo "do hand shaking for private repository"
        roles="${roles} --proteus.credentials $repository"
    fi

    roles="${roles} postgres 
            --proteus.buildbot_pg_slave $repository,$ec2_master_host 
            proteus.replace_pg_hba_conf 
            --proteus.create_pg_db $project_name"

    pf-server-role-add $client $ec2_host $roles
fi
